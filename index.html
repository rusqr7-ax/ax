<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A | X System</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #121212;
      --text-main: #ffffff;
      --text-muted: #888888;
      --border-color: #333333;
      --accent-color: #ffffff;
      --hover-color: #222222;
      --success-color: #4caf50;
      --error-color: #f44336;
      --font-main: 'Inter', system-ui, sans-serif;
      --radius: 4px;
      
      --shift-bg: #222;
      --shift-text: #fff;
      --weekend-bg: rgba(255, 255, 255, 0.05);
      --weekend-text: #ff8a80;
      --b-bg: #e3f2fd;
      --b-text: #1565c0;
    }

    body.light-theme {
      --bg-color: #f5f5f5;
      --card-bg: #ffffff;
      --text-main: #000000;
      --text-muted: #666666;
      --border-color: #dddddd;
      --accent-color: #000000;
      --hover-color: #eeeeee;
      
      --shift-bg: #eee;
      --shift-text: #000;
      --weekend-bg: rgba(255, 0, 0, 0.05);
      --weekend-text: #d32f2f;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-main);
      min-height: 100vh;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      width: 100%;
    }

    .login-card { 
        max-width: 400px; 
        text-align: center; 
        margin: auto; 
    }
    .logo { 
        font-size: 48px; font-weight: 800; margin-bottom: 20px; 
        background: linear-gradient(45deg, var(--text-main), var(--text-muted)); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent; 
    }
    .password-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
    .password-toggle {
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
      cursor: pointer; opacity: 0.6; display: flex; align-items: center;
      z-index: 10;
      pointer-events: auto;
      padding: 5px;
    }
    .password-toggle:hover { opacity: 1; }
    .password-toggle svg { width: 20px; height: 20px; fill: var(--text-muted); pointer-events: none; }

    .input-field {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      padding: 12px 15px;
      font-size: 16px;
      margin-bottom: 10px;
      border-radius: var(--radius);
      transition: border-color 0.2s;
    }
    .input-field:focus { border-color: var(--text-main); }

    button, select, input[type="button"], input[type="submit"] {
       cursor: pointer;
    }

    .btn {
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--text-main);
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
      display: inline-flex; align-items: center; justify-content: center;
      user-select: none;
      border-radius: var(--radius);
    }
    .btn:active { transform: translateY(1px); }
    .btn:hover { background: var(--text-main); color: var(--bg-color); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--text-main); color: var(--bg-color); font-weight: 600; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .btn-danger { border-color: var(--error-color); color: var(--error-color); }
    .btn-danger:hover { background: var(--error-color); color: #fff; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
    h1 { font-size: 32px; letter-spacing: 4px; font-weight: 300; margin: 0; }

    .profile-menu-container { position: relative; }

    .profile-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 10px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: var(--radius);
    }
    .profile-btn:hover { background: var(--hover-color); border-color: var(--border-color); }
    .profile-avatar {
      width: 32px; height: 32px; border-radius: 50%; background: #222; display: grid; place-items: center; overflow: hidden;
    }
    .profile-avatar-text { 
      font-weight:800; color:#fff; font-size:13px; letter-spacing:0; text-transform:uppercase; line-height:1;
      border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      background: linear-gradient(135deg, #2a2a2a, #0f0f0f);
    }
    .profile-info { display: flex; flex-direction: column; text-align: right; }
    .profile-name { font-weight: 600; font-size: 14px; }
    .profile-role { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;}

    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      min-width: 200px;
      z-index: 1000;
      margin-top: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      border-radius: var(--radius);
    }
    .menu-item {
      display: flex; align-items: center; gap: 10px; width: 100%; text-align: left; padding: 12px 15px;
      background: none; border: none; color: var(--text-main); cursor: pointer; border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover { background: var(--hover-color); }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); z-index: 2000;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }
    .modal {
      background: var(--bg-color); 
      border: 1px solid var(--border-color);
      padding: 30px; 
      width: 100%; 
      max-width: 400px;
      position: relative;
      border-radius: 12px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .modal h3 {
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 5px;
    }
    .close-modal { 
        position: absolute; top: 15px; right: 20px; 
        cursor: pointer; font-size: 24px; color: var(--text-muted); 
        transition: color 0.2s;
    }
    .close-modal:hover { color: var(--error-color); }

    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text-main); }
    .tab.active { color: var(--text-main); border-bottom-color: var(--text-main); }

    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { color: var(--text-muted); font-weight: 400; text-transform: uppercase; font-size: 12px; }

    .schedule-switch { margin-bottom: 20px; display: flex; gap: 10px; }
    .schedule-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .month-nav { display: flex; align-items: center; }

    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    .schedule-table th, .schedule-table td {
      border: 1px solid var(--border-color);
      padding: 4px;
      min-width: 35px;
      height: 35px;
      vertical-align: middle;
    }
    .schedule-table th {
      background: var(--card-bg);
      color: var(--text-main);
      font-weight: 600;
    }
    .schedule-table .sticky-col {
      position: sticky; left: 0; background: var(--bg-color); z-index: 2;
      text-align: left;
      font-weight: 600;
      min-width: 120px;
      border-right: 2px solid var(--border-color);
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .schedule-table .weekend {
      background: var(--weekend-bg);
      color: var(--weekend-text);
    }

    .cell-input {
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      color: inherit;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      appearance: none;
      font-size: 11px;
      padding: 0;
      display: block;
    }
    .cell-input:focus { background: var(--hover-color); outline: none; }

    .cell-b { background: var(--b-bg) !important; color: var(--b-text) !important; font-weight: 800; }
    .cell-work { color: var(--text-main); font-weight: 600; }

    .legend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
      font-size: 12px;
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }
    .legend-item { display: flex; gap: 10px; align-items: center; }
    .legend-key { 
      font-weight: bold; width: 24px; height: 24px; 
      display: flex; align-items: center; justify-content: center; 
      border: 1px solid var(--border-color); border-radius: 4px;
    }
    .legend-key.key-b { background: var(--b-bg); color: var(--b-text); }

    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .cal-title { font-weight: 300; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
    .cal-nav { display: flex; gap: 10px; }
    .cal-btn { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); padding: 8px 12px; cursor: pointer; font-size: 14px; border-radius: var(--radius); }
    .cal-btn:hover { background: var(--text-main); color: var(--bg-color); }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); }
    .cal-dow { text-align: center; color: var(--text-muted); padding: 15px 5px; font-size: 10px; text-transform: uppercase; background: var(--card-bg); }

    .cal-day { 
      min-height: 100px; 
      background: var(--card-bg); 
      padding: 10px; 
      display: flex; 
      flex-direction: column; 
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .cal-day:hover { 
      background: var(--hover-color); 
      z-index: 2;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    .cal-day.today { 
        background: var(--hover-color); 
        border: 1px solid var(--text-main); 
    }
    .cal-day.today::after { 
        content: '‚òÖ'; 
        position: absolute; top: 5px; right: 5px; 
        font-size: 10px; color: var(--accent-color); 
    }
    .cal-day.other { opacity: 0.3; pointer-events: none; }

    .daynum { font-weight: 600; font-size: 14px; color: var(--text-muted); margin-bottom: 10px; }

    .shift-marker { 
      font-size: 11px; 
      color: var(--bg-color); 
      background: var(--text-main);
      padding: 6px 8px;
      margin-top: auto;
      border-radius: 4px;
      text-align: center;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .merch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .photo-card { 
      height: 300px; 
      background-size: cover; 
      background-position: center; 
      border: 1px solid var(--border-color); 
      position: relative; 
      border-radius: 12px; 
      overflow: hidden;
      transition: transform 0.3s;
      cursor: pointer;
    }
    .photo-card:hover { transform: scale(1.02); }
    .photo-overlay {
      position: absolute; bottom: 0; left: 0; right: 0; 
      background: linear-gradient(transparent, rgba(0,0,0,0.9)); 
      padding: 20px; 
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .photo-title { font-size: 14px; font-weight: 600; color: #fff; }
    .photo-delete { color: #ff4444; cursor: pointer; font-size: 18px; }

    .manual-list { display: flex; flex-direction: column; gap: 10px; }
    .manual-item {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 15px 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .manual-item:hover { background: var(--hover-color); }
    .manual-info { display: flex; align-items: center; gap: 15px; }
    .manual-icon { font-size: 24px; }
    .manual-name { font-weight: 600; }
    .manual-date { font-size: 12px; color: var(--text-muted); }

    .loader { text-align: center; padding: 20px; color: var(--text-muted); }

    @media (max-width: 768px) {
        .header { flex-direction: column; align-items: flex-start; gap: 20px; }
        .actions { width: 100%; display: flex; justify-content: flex-end; }
        .tabs { overflow-x: auto; white-space: nowrap; flex-wrap: nowrap; padding-bottom: 5px; }
        .schedule-table th, .schedule-table td { min-width: 30px; font-size: 10px; padding: 2px; }
        .cal-day { min-height: 80px; padding: 5px; }
        .shift-marker { font-size: 9px; padding: 2px 4px; }
        .modal { width: 95%; padding: 20px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- LOGIN VIEW -->
  <div id="login-view" class="container login-card" style="display:flex; height: 100vh; flex-direction: column; justify-content: center;">
    <div class="logo">A | X</div>
    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <p style="margin-bottom: 20px; color: #666;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
    
    <input type="text" id="loginEmail" placeholder="–õ–æ–≥–∏–Ω" class="input-field">
    
    <div class="password-wrapper">
      <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="input-field" style="margin-bottom: 0;">
      <div class="password-toggle" id="togglePassword">
        <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </div>
    </div>
    
    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="btnLogin">–í–æ–π—Ç–∏</button>
    <div id="loginErrorMsg" style="color: #f44336; margin-top: 15px; font-size: 14px; min-height: 20px;"></div>
  </div>

  <!-- APP VIEW -->
  <div id="app-view" class="container" style="display:none;">
    <div class="header">
      <div class="header-left">
        <h1>A | X</h1>
      </div>
      
      <div class="actions">
        <div class="profile-menu-container">
          <button class="profile-btn" id="profileBtn">
            <div class="profile-info">
               <span class="profile-name" id="headerLogin">...</span> 
               <span class="profile-role" id="headerRole">...</span>
            </div>
            <div class="profile-avatar profile-avatar-text" id="headerAvatar" aria-label="Avatar"></div>
          </button>
          
          <div class="dropdown-menu" id="profileMenu">
            <button id="themeBtn" class="menu-item">
               <span>üåì</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
            </button>
            <button id="changePassBtn" class="menu-item">
               <span>üîë</span> –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
            </button>
            <button id="logoutBtn" class="menu-item" style="color: #f44336;">
               <span>üö™</span> –í—ã–π—Ç–∏
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: CHANGE PASSWORD -->
    <div id="modalChangePass" class="modal-overlay">
      <div class="modal">
        <span class="close-modal" onclick="closeModal('modalChangePass')">&times;</span>
        <h3 style="margin-bottom:20px;">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
        <input type="password" id="oldPass" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" class="input-field">
        <input type="password" id="newPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="input-field">
        <button class="btn btn-primary" id="btnSavePass">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <!-- MODAL: EDIT USER PASSWORD (ADMIN) -->
    <div id="modalEditUser" class="modal-overlay">
      <div class="modal">
        <span class="close-modal" onclick="closeModal('modalEditUser')">&times;</span>
        <h3 id="editUserTitle">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
        <input type="hidden" id="editUserId">
        <input type="text" id="editUserNewPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="input-field">
        <button class="btn btn-primary" id="btnUpdateUserPass">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="scheduleTab">–ì—Ä–∞—Ñ–∏–∫</button>
      <button class="tab" data-tab="merchTab">–ú–µ—Ä—á–µ–Ω–¥–∞–π–∑–∏–Ω–≥</button>
      <button class="tab" data-tab="manualsTab">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
      <button class="tab" data-tab="adminTab" id="adminTab" style="display:none;">–ê–¥–º–∏–Ω</button>
    </div>

    <!-- TAB: SCHEDULE -->
    <div id="scheduleTab" class="tab-content active">
      <div class="schedule-switch">
        <button class="btn btn-sm active" id="viewMySched">–ú–æ–π –≥—Ä–∞—Ñ–∏–∫</button>
        <button class="btn btn-sm" id="viewTeamSched">–û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫</button>
      </div>
      
      <div id="myScheduleView">
        <div id="calendar-wrapper"></div>
      </div>
      
      <div id="teamScheduleView" style="display:none;">
        <div id="schedule-manager"></div>
      </div>
    </div>

    <!-- TAB: MERCH -->
    <div id="merchTab" class="tab-content">
      <div id="merchAdminControls" style="display:none; margin-bottom:20px; padding:20px; border:1px solid var(--border-color); border-radius:8px;">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
          <input type="text" id="merchTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –í–∏—Ç—Ä–∏–Ω–∞ 1)" class="input-field">
          <input type="text" id="merchUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (URL)" class="input-field">
        </div>
        <button class="btn btn-primary" id="btnAddMerch" style="margin-top:10px;">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="merch-grid" id="merchGrid"></div>
    </div>

    <!-- TAB: MANUALS -->
    <div id="manualsTab" class="tab-content">
      <div id="manualsAdminControls" style="display:none; margin-bottom:20px; padding:20px; border:1px solid var(--border-color); border-radius:8px;">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
          <input type="text" id="manualTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏" class="input-field">
          <input type="text" id="manualUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª (URL)" class="input-field">
        </div>
        <button class="btn btn-primary" id="btnAddManual" style="margin-top:10px;">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="manual-list" id="manualList"></div>
    </div>

    <!-- TAB: ADMIN -->
    <div id="adminTabContent" class="tab-content">
      <div class="card" style="padding:20px; border:1px solid var(--border-color); margin-bottom:20px; border-radius:8px;">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
          <input type="text" id="newUserName" placeholder="–§–ò–û" class="input-field">
          <input type="text" id="newUserEmail" placeholder="–õ–æ–≥–∏–Ω" class="input-field">
          <input type="text" id="newUserPass" placeholder="–ü–∞—Ä–æ–ª—å" class="input-field">
          <select id="newUserRole" class="input-field">
            <option value="seller">–ü—Ä–æ–¥–∞–≤–µ—Ü</option>
            <option value="senior_seller">–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü</option>
            <option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option>
          </select>
        </div>
        <button class="btn btn-primary" id="btnCreateUser" style="margin-top:10px;">–°–æ–∑–¥–∞—Ç—å</button>
      </div>

      <div class="table-responsive">
        <table id="usersTable">
          <thead>
            <tr>
              <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
              <th>–†–æ–ª—å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const SUPABASE_URL = 'https://uuhsjusmhmmjceujzoiw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1aHNqdXNtaG1tamNldWp6b2l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDU0MTUsImV4cCI6MjA4MTE4MTQxNX0.zaOtLcZGoNV77AiLrbODv3gIamlHWh8QwbBdWeOfJLw';
      
      let supabase = null;
      let currentUser = null;
      let globalEmployees = [];
      let globalShiftTypes = [];
      let dataCache = { merch: null, manuals: null, schedule: {} };

      try {
        if (window.supabase && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
      } catch (e) { console.error('Supabase init failed:', e); }
      
      window.appSupabase = supabase;

    async function initDB() {
      if (!supabase) return;
      const shifts = [
        { id: 1, title: '10:00‚Äì19:00', start_time: '10:00', end_time: '19:00', break_start: '14:00', break_end: '15:00', work_hours: 8 },
        { id: 2, title: '13:00‚Äì22:00', start_time: '13:00', end_time: '22:00', break_start: '15:00', break_end: '16:00', work_hours: 8 },
        { id: 3, title: '10:00‚Äì17:00', start_time: '10:00', end_time: '17:00', break_start: '13:00', break_end: '14:00', work_hours: 6 },
        { id: 4, title: '12:00‚Äì19:00', start_time: '12:00', end_time: '19:00', break_start: '15:00', break_end: '16:00', work_hours: 6 },
        { id: 5, title: '13:00‚Äì20:00', start_time: '13:00', end_time: '20:00', break_start: '16:00', break_end: '17:00', work_hours: 6 },
        { id: 6, title: '14:00‚Äì21:00', start_time: '14:00', end_time: '21:00', break_start: '17:00', break_end: '18:00', work_hours: 6 },
        { id: 7, title: '15:00‚Äì22:00', start_time: '15:00', end_time: '22:00', break_start: '18:00', break_end: '19:00', work_hours: 6 },
        { id: 8, title: '10:00‚Äì15:00', start_time: '10:00', end_time: '15:00', break_start: '12:00', break_end: '13:00', work_hours: 5 },
        { id: 9, title: '12:00‚Äì17:00', start_time: '12:00', end_time: '17:00', break_start: '14:00', break_end: '15:00', work_hours: 5 },
        { id: 10, title: '13:00‚Äì18:00', start_time: '13:00', end_time: '18:00', break_start: '15:00', break_end: '16:00', work_hours: 5 },
        { id: 11, title: '15:00‚Äì20:00', start_time: '15:00', end_time: '20:00', break_start: '17:00', break_end: '18:00', work_hours: 5 },
        { id: 12, title: '17:00‚Äì22:00', start_time: '17:00', end_time: '22:00', break_start: '19:00', break_end: '20:00', work_hours: 5 }
      ];
      await supabase.from('shifts').upsert(shifts);
    }

    async function preloadGlobalData() {
      if (!supabase) return;
      const [emp, shifts] = await Promise.all([
        supabase.from('employees').select('*').order('full_name'),
        supabase.from('shifts').select('*').order('id')
      ]);
      globalEmployees = emp.data || [];
      globalShiftTypes = shifts.data || [];
    }

    async function loginUser(login, password) {
      if (!supabase) throw new Error('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      const { data, error } = await supabase.from('employees').select('*').eq('login', login).eq('password', password).single();
      if (error || !data) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
      localStorage.setItem('ax_user', JSON.stringify(data));
      return data;
    }

    function getCurrentUser() {
      const userStr = localStorage.getItem('ax_user');
      return userStr ? JSON.parse(userStr) : null;
    }

    function logoutUser() { localStorage.removeItem('ax_user'); location.reload(); }
    window.closeModal = function(id) { const m = document.getElementById(id); if (m) m.style.display = 'none'; }

    function computeInitials(nameOrLogin) {
      const raw = String(nameOrLogin || '').trim();
      if (!raw) return 'UU';
      const parts = raw.split(/[\s-]+/).filter(Boolean);
      return parts.length >= 2 ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase() : raw.slice(0, 2).toUpperCase();
    }

    function sortEmployees(list) {
      const rank = { director: 0, senior_seller: 1, seller: 2 };
      return [...(list || [])].sort((a, b) => {
        const ra = rank[a.role] ?? 99, rb = rank[b.role] ?? 99;
        if (ra !== rb) return ra - rb;
        return (a.full_name || a.login || '').localeCompare(b.full_name || b.login || '', 'ru');
      });
    }

    // === CALENDAR CLASS ===
    class Calendar {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.cursor = new Date();
        this.shifts = new Map();
        this.init();
      }
      async init() { this.renderStructure(); this.attachEvents(); await this.loadMyShifts(); }
      async loadMyShifts() {
        if (!supabase || !currentUser) return;
        const y = this.cursor.getFullYear(), m = this.cursor.getMonth() + 1;
        const monthStr = `${y}-${String(m).padStart(2, '0')}`;
        const { data } = await supabase.from('schedule').select('date, shift_id').eq('user_id', currentUser.id).eq('month', monthStr);
        this.shifts.clear();
        if (data) data.forEach(item => {
          if (item.shift_id) {
            const s = globalShiftTypes.find(x => String(x.id) === String(item.shift_id));
            if (s) this.shifts.set(item.date, s);
          }
        });
        this.render();
      }
      renderStructure() {
        this.container.innerHTML = `<div class="card calendar-card" style="background:transparent; border:none; padding:0;">
          <div class="cal-header"><div class="cal-title" id="calTitle"></div><div class="cal-nav">
            <button class="cal-btn" id="calPrev">‚Üê</button><button class="cal-btn" id="calToday">–°–µ–≥–æ–¥–Ω—è</button><button class="cal-btn" id="calNext">‚Üí</button>
          </div></div><div class="cal-grid" id="calDow"></div><div class="cal-grid" id="calGrid"></div></div>`;
        ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d => {
          const el = document.createElement('div'); el.className = 'cal-dow'; el.textContent = d; document.getElementById('calDow').appendChild(el);
        });
      }
      attachEvents() {
        document.getElementById('calPrev').onclick = () => { this.cursor.setMonth(this.cursor.getMonth() - 1); this.loadMyShifts(); };
        document.getElementById('calNext').onclick = () => { this.cursor.setMonth(this.cursor.getMonth() + 1); this.loadMyShifts(); };
        document.getElementById('calToday').onclick = () => { this.cursor = new Date(); this.loadMyShifts(); };
      }
      render() {
        const grid = document.getElementById('calGrid'), title = document.getElementById('calTitle');
        grid.innerHTML = '';
        const y = this.cursor.getFullYear(), m = this.cursor.getMonth();
        title.textContent = new Date(y, m, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        let startOffset = (new Date(y, m, 1).getDay() || 7) - 1;
        for(let i=0; i<startOffset; i++) { const el = document.createElement('div'); el.className = 'cal-day other'; grid.appendChild(el); }
        const daysInMonth = new Date(y, m+1, 0).getDate(), todayStr = new Date().toISOString().slice(0, 10);
        for(let d=1; d<=daysInMonth; d++) {
          const dateObj = new Date(y, m, d);
          const dateKey = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
          const cell = document.createElement('div'); cell.className = 'cal-day'; if (dateKey === todayStr) cell.classList.add('today');
          cell.innerHTML = `<div class="daynum">${d}</div>`;
          if (this.shifts.has(dateKey)) {
            const shift = this.shifts.get(dateKey);
            cell.innerHTML += `<div class="shift-marker">${shift.start_time.slice(0,5)} - ${shift.end_time.slice(0,5)}</div>`;
          }
          grid.appendChild(cell);
        }
      }
    }

    // === SCHEDULE MANAGER CLASS ===
    class ScheduleManager {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.currentDate = new Date();
        this.employees = [];
        this.shiftTypes = [];
        this.scheduleData = [];
        this.editMode = false;
        this.roleFilter = 'all';
      }
      async init() {
        this.employees = sortEmployees(globalEmployees);
        this.shiftTypes = globalShiftTypes;
        this.renderControls();
        await this.loadMonthData();
      }
      renderControls() {
        const y = this.currentDate.getFullYear(), m = this.currentDate.getMonth();
        const monthName = new Date(y, m, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        this.container.innerHTML = `<div class="schedule-controls"><div class="month-nav">
          <button id="schedPrev" class="btn btn-sm">‚Üê</button><h2 style="text-transform: capitalize; margin: 0 15px;">${monthName}</h2><button id="schedNext" class="btn btn-sm">‚Üí</button>
          </div><div class="schedule-tools" style="display:flex;gap:10px;align-items:center;">
          <select id="roleFilter" class="input-field" style="max-width:220px"><option value="all">–í—Å–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</option><option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option><option value="senior_seller">–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü</option><option value="seller">–ü—Ä–æ–¥–∞–≤–µ—Ü</option></select>
          ${currentUser && currentUser.role === 'director' ? '<button id="toggleEditMode" class="btn btn-sm">–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è: –≤—ã–∫–ª</button>' : ''}
          </div></div><div class="table-responsive"><table class="schedule-table" id="schedTable"><thead id="schedHead"></thead><tbody id="schedBody"></tbody><tfoot id="schedFoot"></tfoot></table></div><div id="schedLegend" class="legend-grid"></div>`;
        document.getElementById('schedPrev').onclick = () => this.changeMonth(-1);
        document.getElementById('schedNext').onclick = () => this.changeMonth(1);
        const roleSel = document.getElementById('roleFilter');
        if (roleSel) { roleSel.value = this.roleFilter; roleSel.onchange = () => { this.roleFilter = roleSel.value; this.renderTable(y, m); }; }
        const editBtn = document.getElementById('toggleEditMode');
        if (editBtn) { editBtn.onclick = () => { this.editMode = !this.editMode; editBtn.textContent = `–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è: ${this.editMode ? '–≤–∫–ª' : '–≤—ã–∫–ª'}`; this.renderTable(y, m); }; }
        this.renderLegend();
      }
      renderLegend() {
        const leg = document.getElementById('schedLegend'); leg.innerHTML = '';
        const groups = [{ title: '–î–∏—Ä–µ–∫—Ç–æ—Ä (1.0)', ids: [1, 2], color: '#ffeb3b' }, { title: '–ü—Ä–æ–¥–∞–≤—Ü—ã (0.75)', ids: [3, 4, 5, 6, 7], color: '#4caf50' }, { title: '–ü—Ä–æ–¥–∞–≤—Ü—ã (0.5)', ids: [8, 9, 10, 11, 12], color: '#2196f3' }];
        groups.forEach(group => {
          const header = document.createElement('div'); header.style.gridColumn = '1 / -1'; header.style.marginTop = '15px'; header.style.fontWeight = 'bold'; header.textContent = group.title; leg.appendChild(header);
          this.shiftTypes.filter(s => group.ids.includes(s.id)).forEach(s => {
            const div = document.createElement('div'); div.className = 'legend-item'; div.innerHTML = `<div class="legend-key" style="border-color:${group.color}; color:${group.color}">${s.id}</div><span>${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)}</span>`; leg.appendChild(div);
          });
        });
      }
      changeMonth(delta) { this.currentDate.setMonth(this.currentDate.getMonth() + delta); this.renderControls(); this.loadMonthData(); }
      async loadMonthData() {
        const y = this.currentDate.getFullYear(), m = this.currentDate.getMonth() + 1;
        const monthStr = `${y}-${String(m).padStart(2, '0')}`;
        if (dataCache.schedule[monthStr]) { this.scheduleData = dataCache.schedule[monthStr]; }
        else {
          const { data } = await supabase.from('schedule').select('*').eq('month', monthStr);
          this.scheduleData = data || []; dataCache.schedule[monthStr] = this.scheduleData;
        }
        this.renderTable(y, m - 1);
      }
      renderTable(year, month) {
        const thead = document.getElementById('schedHead'), tbody = document.getElementById('schedBody'), tfoot = document.getElementById('schedFoot');
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let list = (this.roleFilter === 'all') ? this.employees : this.employees.filter(u => u.role === this.roleFilter);
        list = sortEmployees(list);
        let headerHtml = '<tr><th rowspan="2">‚Ññ</th><th rowspan="2" class="sticky-col">–§–∞–º–∏–ª–∏—è –ò. –û.</th><th rowspan="2">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>';
        for (let d = 1; d <= daysInMonth; d++) {
          const dayName = new Date(year, month, d).toLocaleDateString('ru-RU', { weekday: 'short' });
          headerHtml += `<th class="${(dayName === '—Å–±' || dayName === '–≤—Å') ? 'weekend' : ''}">${d}</th>`;
        }
        headerHtml += '<th rowspan="2">–ß–∞—Å—ã</th><th rowspan="2">–í—ã—Ö</th></tr><tr>';
        for (let d = 1; d <= daysInMonth; d++) {
          const dayName = new Date(year, month, d).toLocaleDateString('ru-RU', { weekday: 'short' });
          headerHtml += `<th class="${(dayName === '—Å–±' || dayName === '–≤—Å') ? 'weekend' : ''}" style="font-size:10px">${dayName}</th>`;
        }
        headerHtml += '</tr>'; thead.innerHTML = headerHtml;
        const dayCounts = new Array(daysInMonth + 1).fill(0); tbody.innerHTML = '';
        list.forEach((user, idx) => {
          const tr = document.createElement('tr'); let totalHours = 0, totalDaysOff = 0;
          let roleName = user.role === 'director' ? '–î–∏—Ä–µ–∫—Ç–æ—Ä' : (user.role === 'senior_seller' ? '–°—Ç. –ø—Ä–æ–¥–∞–≤–µ—Ü' : '–ü—Ä–æ–¥–∞–≤–µ—Ü');
          let html = `<td>${idx + 1}</td><td class="sticky-col">${user.full_name}</td><td>${roleName}</td>`;
          for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const record = this.scheduleData.find(s => s.user_id === user.id && s.date === dateStr);
            const shiftId = record ? record.shift_id : null;
            if (shiftId) {
              dayCounts[d]++; const sInfo = this.shiftTypes.find(s => s.id === shiftId);
              if (sInfo) totalHours += parseFloat(sInfo.work_hours);
            } else totalDaysOff++;
            if (currentUser.role === 'director' && this.editMode) {
              html += `<td><select class="cell-input ${shiftId ? 'cell-work' : 'cell-b'}" data-user-id="${user.id}" data-date="${dateStr}" onchange="window.handleShiftChange(this)">
                        <option value="">B</option>${this.shiftTypes.map(st => `<option value="${st.id}" ${shiftId === st.id ? 'selected' : ''}>${st.id}</option>`).join('')}</select></td>`;
            } else html += `<td><div class="cell-input ${shiftId ? 'cell-work' : 'cell-b'}">${shiftId || 'B'}</div></td>`;
          }
          html += `<td><b>${totalHours}</b></td><td>${totalDaysOff}</td>`; tr.innerHTML = html; tbody.appendChild(tr);
        });
        let footHtml = '<tr><td colspan="3" style="text-align:right; font-weight:bold;">–ò—Ç–æ–≥–æ —Å–º–µ–Ω:</td>';
        for (let d = 1; d <= daysInMonth; d++) footHtml += `<td><b>${dayCounts[d]}</b></td>`;
        footHtml += '<td>-</td><td>-</td></tr>'; tfoot.innerHTML = footHtml;
      }
    }

    window.handleShiftChange = async function(select) {
      const { userId, date } = select.dataset; const shiftId = select.value ? parseInt(select.value) : null;
      const { error } = await supabase.from('schedule').upsert({ user_id: userId, date: date, month: date.slice(0, 7), shift_id: shiftId, is_day_off: !shiftId }, { onConflict: 'user_id, date' });
      if (error) alert(error.message);
      else {
        select.className = `cell-input ${shiftId ? 'cell-work' : 'cell-b'}`;
        if (window.scheduleApp) {
          const monthStr = date.slice(0, 7);
          const idx = window.scheduleApp.scheduleData.findIndex(s => s.user_id === userId && s.date === date);
          if (idx >= 0) window.scheduleApp.scheduleData[idx].shift_id = shiftId;
          else window.scheduleApp.scheduleData.push({ user_id: userId, date, shift_id: shiftId });
          dataCache.schedule[monthStr] = window.scheduleApp.scheduleData;
          window.scheduleApp.renderTable(window.scheduleApp.currentDate.getFullYear(), window.scheduleApp.currentDate.getMonth());
        }
      }
    };

    async function loadMerch() {
      const grid = document.getElementById('merchGrid'); if (dataCache.merch) { renderMerch(dataCache.merch); return; }
      grid.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      const { data } = await supabase.from('merch').select('*').order('created_at', { ascending: false });
      dataCache.merch = data; renderMerch(data);
    }
    function renderMerch(data) {
      const grid = document.getElementById('merchGrid'); grid.innerHTML = '';
      if (data) data.forEach(item => {
        const card = document.createElement('div'); card.className = 'photo-card'; card.style.backgroundImage = `url('${item.url}')`;
        card.innerHTML = `<div class="photo-overlay"><span class="photo-title">${item.title}</span>${currentUser.role === 'director' ? `<span class="photo-delete" onclick="deleteMerch('${item.id}')">&times;</span>` : ''}</div>`;
        grid.appendChild(card);
      });
    }
    window.deleteMerch = async (id) => { if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ?')) return; await supabase.from('merch').delete().eq('id', id); dataCache.merch = null; loadMerch(); };

    async function loadManuals() {
      const list = document.getElementById('manualList'); if (dataCache.manuals) { renderManuals(dataCache.manuals); return; }
      list.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      const { data } = await supabase.from('manuals').select('*').order('created_at', { ascending: false });
      dataCache.manuals = data; renderManuals(data);
    }
    function renderManuals(data) {
      const list = document.getElementById('manualList'); list.innerHTML = '';
      if (data) data.forEach(item => {
        const div = document.createElement('div'); div.className = 'manual-item';
        div.innerHTML = `<div class="manual-info"><span class="manual-icon">üìÑ</span><div><div class="manual-name">${item.title}</div><div class="manual-date">${new Date(item.created_at).toLocaleDateString()}</div></div></div><div style="display:flex; gap:10px;"><a href="${item.url}" target="_blank" class="btn btn-sm">–û—Ç–∫—Ä—ã—Ç—å</a>${currentUser.role === 'director' ? `<button class="btn btn-sm btn-danger" onclick="deleteManual('${item.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}</div>`;
        list.appendChild(div);
      });
    }
    window.deleteManual = async (id) => { if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é?')) return; await supabase.from('manuals').delete().eq('id', id); dataCache.manuals = null; loadManuals(); };

    async function loadUsersTable() {
      const tbody = document.querySelector('#usersTable tbody'); if (!tbody) return;
      await preloadGlobalData(); tbody.innerHTML = '';
      globalEmployees.forEach(u => {
        const tr = document.createElement('tr'); const roleNames = { 'director': '–î–∏—Ä–µ–∫—Ç–æ—Ä', 'senior_seller': '–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü', 'seller': '–ü—Ä–æ–¥–∞–≤–µ—Ü' };
        tr.innerHTML = `<td><b>${u.full_name}</b><br><small style="color:#888">${u.login} | ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</small></td><td>${roleNames[u.role] || u.role}</td><td><button class="btn btn-sm" onclick="openEditUser('${u.id}', '${u.full_name}')">–ü–∞—Ä–æ–ª—å</button><button class="btn btn-sm btn-danger" onclick="deleteUserHandler('${u.id}')">–£–¥–∞–ª–∏—Ç—å</button></td>`;
        tbody.appendChild(tr);
      });
    }
    window.openEditUser = (id, name) => { document.getElementById('editUserId').value = id; document.getElementById('editUserTitle').textContent = `–ü–∞—Ä–æ–ª—å: ${name}`; document.getElementById('modalEditUser').style.display = 'flex'; };
    window.deleteUserHandler = async (id) => { if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return; await supabase.from('employees').delete().eq('id', id); loadUsersTable(); };

    function showLoginView() { document.getElementById('login-view').style.display = 'flex'; document.getElementById('app-view').style.display = 'none'; initLoginEvents(); }
    async function showAppView() { document.getElementById('login-view').style.display = 'none'; document.getElementById('app-view').style.display = 'block'; await initApp(); }

    function initLoginEvents() {
      const toggleBtn = document.getElementById('togglePassword'), passInput = document.getElementById('loginPassword'), loginBtn = document.getElementById('btnLogin'), loginEmail = document.getElementById('loginEmail'), errBox = document.getElementById('loginErrorMsg');
      loginBtn.onclick = async () => {
        const login = loginEmail.value.trim(), password = passInput.value.trim(); if (!login || !password) return errBox.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è';
        loginBtn.disabled = true; loginBtn.textContent = '–í—Ö–æ–¥...';
        try { await loginUser(login, password); location.reload(); } catch (err) { loginBtn.disabled = false; loginBtn.textContent = '–í–æ–π—Ç–∏'; errBox.textContent = err.message; }
      };
      toggleBtn.onclick = () => { const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password'; passInput.setAttribute('type', type); };
      loginEmail.onkeydown = passInput.onkeydown = (e) => { if (e.key === 'Enter') loginBtn.click(); };
    }

    async function initApp() {
      await Promise.all([initDB(), preloadGlobalData()]);
      if (currentUser) {
        document.getElementById('headerLogin').textContent = currentUser.full_name || currentUser.login;
        const roles = { 'director': '–î–∏—Ä–µ–∫—Ç–æ—Ä', 'senior_seller': '–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü', 'seller': '–ü—Ä–æ–¥–∞–≤–µ—Ü' };
        document.getElementById('headerRole').textContent = roles[currentUser.role] || currentUser.role;
        document.getElementById('headerAvatar').textContent = computeInitials(currentUser.full_name || currentUser.login);
        if (currentUser.role === 'director') { document.getElementById('adminTab').style.display = 'block'; document.getElementById('merchAdminControls').style.display = 'block'; document.getElementById('manualsAdminControls').style.display = 'block'; loadUsersTable(); }
      }
      window.calendarApp = new Calendar('calendar-wrapper'); window.scheduleApp = new ScheduleManager('schedule-manager'); await window.scheduleApp.init();
      loadMerch(); loadManuals();
      document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
          document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); t.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          const targetId = t.dataset.tab === 'adminTab' ? 'adminTabContent' : t.dataset.tab; document.getElementById(targetId).classList.add('active');
        };
      });
      const pBtn = document.getElementById('profileBtn'), pMenu = document.getElementById('profileMenu');
      pBtn.onclick = (e) => { e.stopPropagation(); pMenu.style.display = pMenu.style.display === 'block' ? 'none' : 'block'; };
      document.addEventListener('click', () => pMenu.style.display = 'none');
      document.getElementById('logoutBtn').onclick = logoutUser;
      document.getElementById('themeBtn').onclick = () => { document.body.classList.toggle('light-theme'); localStorage.setItem('ax_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark'); };
      if (localStorage.getItem('ax_theme') === 'light') document.body.classList.add('light-theme');
      document.getElementById('btnUpdateUserPass').onclick = async () => {
        const id = document.getElementById('editUserId').value, pass = document.getElementById('editUserNewPass').value; if (!pass) return alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
        await supabase.from('employees').update({ password: pass }).eq('id', id); alert('–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω'); closeModal('modalEditUser'); loadUsersTable();
      };
      document.getElementById('btnCreateUser').onclick = async () => {
        const login = document.getElementById('newUserEmail').value.trim(), password = document.getElementById('newUserPass').value.trim(), full_name = document.getElementById('newUserName').value.trim(), role = document.getElementById('newUserRole').value;
        if (!login || !password || !full_name) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è'); await supabase.from('employees').insert({ login, password, full_name, role }); alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω'); loadUsersTable();
      };
      document.getElementById('btnAddMerch').onclick = async () => {
        const title = document.getElementById('merchTitle').value, url = document.getElementById('merchUrl').value; if (!title || !url) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        await supabase.from('merch').insert({ title, url }); dataCache.merch = null; loadMerch();
      };
      document.getElementById('btnAddManual').onclick = async () => {
        const title = document.getElementById('manualTitle').value, url = document.getElementById('manualUrl').value; if (!title || !url) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        await supabase.from('manuals').insert({ title, url }); dataCache.manuals = null; loadManuals();
      };
    }
    document.addEventListener('DOMContentLoaded', () => { currentUser = getCurrentUser(); if (currentUser) showAppView(); else showLoginView(); });
    })();
  </script>
</body>
</html>
