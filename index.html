<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A | X System</title>
  <link rel="icon" href="faviconarmaniwhite.png" type="image/png">
  <link rel="apple-touch-icon" href="faviconarmaniwhite.png">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="style.css">

  <!-- SCRIPTS -->
  <!-- 1. External Deps -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- ==================== LOGIN VIEW ==================== -->
  <div id="login-view" class="container login-card" style="display:flex; height: 100vh; flex-direction: column; justify-content: center;">
    <div class="logo">A | X</div>
    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <p style="margin-bottom: 20px; color: #666;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
    
    <input type="text" id="loginEmail" placeholder="–õ–æ–≥–∏–Ω" class="input-field">
    
    <div class="password-wrapper">
      <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="input-field" style="margin-bottom: 0;">
      <div class="password-toggle" id="togglePassword">
        <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </div>
    </div>
    
    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="btnLogin">–í–æ–π—Ç–∏</button>
    <div id="loginErrorMsg" style="color: #f44336; margin-top: 15px; font-size: 14px; min-height: 20px;"></div>
  </div>

  <!-- ==================== APP VIEW ==================== -->
  <div id="app-view" class="container" style="display:none;">
    <div class="header">
      <div class="header-left">
        <h1>A | X</h1>
      </div>
      
      <div class="actions">
        <div class="profile-menu-container">
          <button class="profile-btn" id="profileBtn">
            <div class="profile-info">
               <span class="profile-name" id="headerLogin">...</span> 
               <span class="profile-role" id="headerRole">...</span>
            </div>
            <img src="https://ui-avatars.com/api/?name=User&background=333&color=fff" class="profile-avatar" id="headerAvatar" alt="Foto">
          </button>
          
          <div class="dropdown-menu" id="profileMenu">
            <button id="themeBtn" class="menu-item">
               <span>üåì</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
            </button>
            <button id="changePhotoBtn" class="menu-item">
               <span>üì∏</span> –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ
            </button>
            <button id="changePassBtn" class="menu-item">
               <span>üîí</span> –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
            </button>
            <button id="logoutBtn" class="menu-item" style="color: #f44336;">
               <span>üö™</span> –í—ã–π—Ç–∏
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: CHANGE PASSWORD -->
    <div id="modalChangePass" class="modal-overlay">
      <div class="modal">
        <span class="close-modal" onclick="document.getElementById('modalChangePass').style.display='none'">&times;</span>
        <h3 style="margin-bottom:20px;">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
        <input type="password" id="oldPass" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" class="input-field">
        <input type="password" id="newPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="input-field">
        <button class="btn btn-primary" id="btnSavePass" style="width:100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
    <!-- MODAL: INFO -->
    <div id="modalInfo" class="modal-overlay">
      <div class="modal">
        <span class="close-modal" onclick="closeModal('modalInfo')">&times;</span>
        <h3 id="modalTitle"></h3>
        <div id="modalBody" style="white-space:pre-wrap"></div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="schedule">–ì—Ä–∞—Ñ–∏–∫</button>
      <button class="tab" data-tab="tab-1s">1–°</button>
      <button class="tab" data-tab="merch">–ú–µ—Ä—á</button>
      <button class="tab" data-tab="operations">–û–ø–µ—Ä–∞—Ü–∏–∏</button>
      <button class="tab" data-tab="admin" id="adminTab" style="display:none">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
    </div>

    <!-- CONTENT: SCHEDULE -->
    <div class="tab-content active" id="schedule">
      <div class="schedule-switch">
        <button class="btn btn-sm active" id="viewMySched">–ú–æ–π</button>
        <button class="btn btn-sm" id="viewTeamSched">–û–±—â–∏–π</button>
      </div>
      
      <div id="myScheduleView">
        <div id="calendar-wrapper"></div>
      </div>

      <div id="teamScheduleView" style="display:none;">
        <div id="schedule-manager"></div>
      </div>
    </div>

    <!-- CONTENT: OPERATIONS -->
    <div class="tab-content" id="operations">
      <h2>–û–ø–µ—Ä–∞—Ü–∏–∏</h2>
      <p>–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
    </div>

    <!-- CONTENT: 1S -->
    <div class="tab-content" id="tab-1s">
      <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ 1–°</h2>
      <input type="text" class="input-field search-input" placeholder="–ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π...">
      <div class="list-group" style="margin-top: 20px;"></div>
    </div>

    <!-- CONTENT: MERCH -->
    <div class="tab-content" id="merch">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h2>–ú–µ—Ä—á–∞–Ω–¥–∞–π–∑–∏–Ω–≥</h2>
        <button class="btn btn-sm" id="btnUploadMerch">–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞</button>
        <input type="file" id="uploadMerchInput" hidden accept="image/*,video/*">
      </div>
      <div class="merch-grid" id="merchGrid"></div>
    </div>

    <!-- CONTENT: ADMIN -->
    <div class="tab-content" id="admin">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</h2>
      <div style="margin-bottom: 20px; padding: 20px; border: 1px solid var(--border-color);">
        <h3>–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
        <input type="text" id="newUserName" placeholder="–§–ò–û" class="input-field">
        <input type="text" id="newUserEmail" placeholder="–õ–æ–≥–∏–Ω" class="input-field">
        <input type="text" id="newUserPass" placeholder="–ü–∞—Ä–æ–ª—å" class="input-field">
        <select id="newUserRole" class="input-field">
          <option value="seller">–ü—Ä–æ–¥–∞–≤–µ—Ü</option>
          <option value="senior_seller">–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü</option>
          <option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option>
        </select>
        <button class="btn btn-primary" id="btnCreateUser">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
      
      <table id="usersTable">
        <thead>
          <tr>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th>–†–æ–ª—å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- MODAL: EDIT USER -->
    <div id="modalEditUser" class="modal-overlay">
      <div class="modal">
        <span class="close-modal" onclick="closeModal('modalEditUser')">&times;</span>
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
        <input type="text" id="editUserName" placeholder="–§–ò–û" class="input-field">
        <input type="text" id="editUserLogin" placeholder="–õ–æ–≥–∏–Ω" class="input-field">
        <input type="text" id="editUserPass" placeholder="–ü–∞—Ä–æ–ª—å" class="input-field">
        <select id="editUserRole" class="input-field">
          <option value="seller">–ü—Ä–æ–¥–∞–≤–µ—Ü</option>
          <option value="senior_seller">–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü</option>
          <option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option>
        </select>
        <input type="file" id="editPhotoInput" accept="image/*" hidden>
        <button class="btn" id="btnEditPhoto">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button class="btn btn-primary" id="btnSaveUser">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
  <!-- GLOBAL LOADER -->
  <div id="loaderOverlay" class="modal-overlay" style="display:none; align-items:center; justify-content:center;">
    <div class="modal" style="max-width:300px; text-align:center;">
      <div class="loader" id="loaderText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
  <div id="toast" class="toast" style="display:none"></div>

  <!-- INLINED SCRIPTS FOR STABILITY -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
       // Suppress benign resize observer errors
       if (msg.includes('ResizeObserver')) return;
       // Alert critical errors
       alert('System Error: ' + msg + '\nLine: ' + line);
       console.error(error);
    };

    // --- 1. SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://uuhsjusmhmmjceujzoiw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1aHNqdXNtaG1tamNldWp6b2l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDU0MTUsImV4cCI6MjA4MTE4MTQxNX0.zaOtLcZGoNV77AiLrbODv3gIamlHWh8QwbBdWeOfJLw';
    let supabase = null;
    try {
      if (window.supabase && typeof window.supabase.createClient === 'function') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (e) {
      console.warn('Supabase init failed:', e);
    }

    // --- 2. GLOBAL STATE ---
    let currentUser = null;
    let globalEmployees = [];
    let globalShiftTypes = [];
    let globalMerch = [];

    // --- 3. HELPER FUNCTIONS (API) ---
    async function preloadGlobalData() {
      if (!supabase) { globalEmployees = []; globalShiftTypes = []; return; }
       // Parallel fetch
       const [emp, shifts] = await Promise.all([
         supabase.from('employees').select('*').order('full_name'),
         supabase.from('shifts').select('*').order('id')
       ]);
       globalEmployees = emp.data || [];
       globalShiftTypes = shifts.data || [];
    }

    async function loginUser(login, password) {
      if (!supabase) throw new Error('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      const { data, error } = await supabase
        .from('employees')
        .select('*')
        .eq('login', login)
        .eq('password', password)
        .single();

      if (error || !data) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
      localStorage.setItem('ax_user', JSON.stringify(data));
      return data;
    }

    function getCurrentUser() {
      const userStr = localStorage.getItem('ax_user');
      return userStr ? JSON.parse(userStr) : null;
    }

    function logoutUser() {
      localStorage.removeItem('ax_user');
      location.reload();
    }

    async function getAllEmployees() {
      if (globalEmployees.length > 0) return globalEmployees;
      if (!supabase) { globalEmployees = []; return globalEmployees; }
      const { data } = await supabase.from('employees').select('*').order('full_name');
      globalEmployees = data || [];
      return globalEmployees;
    }

    function sortEmployeesForSchedule(list) {
      const rank = { director: 0, senior_seller: 1, seller: 2 };
      return [...(list || [])].sort((a, b) => {
        const ra = rank[a.role] ?? 99;
        const rb = rank[b.role] ?? 99;
        if (ra !== rb) return ra - rb;
        const an = a.full_name || a.login || '';
        const bn = b.full_name || b.login || '';
        return an.localeCompare(bn, 'ru', { sensitivity: 'base' });
      });
    }

    async function createEmployee(data) {
      if (!supabase) return { error: { message: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' } };
      const res = await supabase.from('employees').insert(data);
      if (!res.error) {
         // Refresh cache
         const { data: newData } = await supabase.from('employees').select('*').order('full_name');
         globalEmployees = newData || [];
      }
      return res;
    }

    async function updateEmployee(id, data) {
      if (!supabase) return { error: { message: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' } };
      const res = await supabase.from('employees').update(data).eq('id', id);
      if (!res.error) {
        const idx = globalEmployees.findIndex(e => e.id === id);
        if (idx >= 0) globalEmployees[idx] = { ...globalEmployees[idx], ...data };
      }
      return res;
    }

    async function deleteEmployee(id) {
      if (!supabase) return { error: { message: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' } };
      const res = await supabase.from('employees').delete().eq('id', id);
      if (!res.error) {
         globalEmployees = globalEmployees.filter(e => e.id !== id);
      }
      return res;
    }

    async function getShiftTypes() {
      // Always fetch fresh to ensure we have latest added shifts
      if (!supabase) { globalShiftTypes = []; return globalShiftTypes; }
      const { data } = await supabase.from('shifts').select('*').order('id');
      globalShiftTypes = data || [];
      return globalShiftTypes;
    }

    async function createShiftType(shiftData) {
      if (!supabase) return { error: { message: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' } };
      // shiftData: { title, start_time, end_time }
      const res = await supabase.from('shifts').insert(shiftData);
      if (!res.error) {
         // Refresh cache
         await getShiftTypes();
      }
      return res;
    }

    async function getMerchItems() {
      if (!supabase) return [];
      const { data } = await supabase.from('merch_items').select('*');
      return data || [];
    }

    async function createMerchItem(title, url) {
      if (!supabase) return { error: { message: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' } };
      return await supabase.from('merch_items').insert({ title, image_url: url });
    }

    async function uploadFile(bucket, file) {
      if (!supabase) throw new Error('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
      const ext = file.name.split('.').pop();
      const path = `${Math.random()}.${ext}`;
      await supabase.storage.from(bucket).upload(path, file);
      const { data } = supabase.storage.from(bucket).getPublicUrl(path);
      return data.publicUrl;
    }

    // --- UI LOADER ---
    function showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
      const overlay = document.getElementById('loaderOverlay');
      const t = document.getElementById('loaderText');
      if (t) t.textContent = text;
      if (overlay) overlay.style.display = 'flex';
    }
    function hideLoader() {
      const overlay = document.getElementById('loaderOverlay');
      if (overlay) overlay.style.display = 'none';
    }

    // --- SEED SHIFTS ---
    const SHIFTS_DATA = [
      // 1Ô∏è‚É£ –°–ú–ï–ù–´ –î–ò–†–ï–ö–¢–û–†–ê (8—á)
      { id: 1, title: '10:00‚Äì19:00', start_time: '10:00', end_time: '19:00', break_start: '14:00', break_end: '15:00', work_hours: 8 },
      { id: 2, title: '13:00‚Äì22:00', start_time: '13:00', end_time: '22:00', break_start: '15:00', break_end: '16:00', work_hours: 8 },

      // 2Ô∏è‚É£ –°–ú–ï–ù–´ –ü–†–û–î–ê–í–¶–û–í 0.75 (6—á)
      { id: 3, title: '10:00‚Äì17:00', start_time: '10:00', end_time: '17:00', break_start: '13:00', break_end: '14:00', work_hours: 6 },
      { id: 4, title: '12:00‚Äì19:00', start_time: '12:00', end_time: '19:00', break_start: '15:00', break_end: '16:00', work_hours: 6 },
      { id: 5, title: '13:00‚Äì20:00', start_time: '13:00', end_time: '20:00', break_start: '16:00', break_end: '17:00', work_hours: 6 },
      { id: 6, title: '14:00‚Äì21:00', start_time: '14:00', end_time: '21:00', break_start: '17:00', break_end: '18:00', work_hours: 6 },
      { id: 7, title: '15:00‚Äì22:00', start_time: '15:00', end_time: '22:00', break_start: '18:00', break_end: '19:00', work_hours: 6 },

      // 3Ô∏è‚É£ –°–ú–ï–ù–´ –ü–†–û–î–ê–í–¶–û–í 0.5 (5—á)
      { id: 8, title: '10:00‚Äì15:00', start_time: '10:00', end_time: '15:00', break_start: '12:00', break_end: '13:00', work_hours: 5 },
      { id: 9, title: '12:00‚Äì17:00', start_time: '12:00', end_time: '17:00', break_start: '14:00', break_end: '15:00', work_hours: 5 },
      { id: 10, title: '13:00‚Äì18:00', start_time: '13:00', end_time: '18:00', break_start: '15:00', break_end: '16:00', work_hours: 5 },
      { id: 11, title: '15:00‚Äì20:00', start_time: '15:00', end_time: '20:00', break_start: '17:00', break_end: '18:00', work_hours: 5 },
      { id: 12, title: '17:00‚Äì22:00', start_time: '17:00', end_time: '22:00', break_start: '19:00', break_end: '20:00', work_hours: 5 }
    ];

    async function seedShifts() {
      if (!supabase) { console.error('Supabase not init'); return; }
      // Quietly seed/update shifts
      for (const shift of SHIFTS_DATA) {
        await supabase.from('shifts').upsert(shift);
      }
    }

    // --- 4. CLASSES ---
    class Calendar {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.cursor = new Date();
        this.shifts = new Map(); 
        this.init();
      }

      async init() {
        this.renderStructure();
        this.attachEvents();
        await this.loadMyShifts();
      }

      async loadMyShifts() {
        if (!supabase) { this.shifts.clear(); this.render(); return; }
        if (!currentUser) return;
        const y = this.cursor.getFullYear();
        const m = this.cursor.getMonth() + 1;
        const monthStr = `${y}-${String(m).padStart(2, '0')}`;

        const { data } = await supabase
          .from('schedule')
          .select('date, shift_id')
          .eq('user_id', currentUser.id)
          .eq('month', monthStr);

        this.shifts.clear();
        if (data) {
          data.forEach(item => {
            if (item.shift_id) {
              const s = (globalShiftTypes || []).find(x => String(x.id) === String(item.shift_id));
              if (s) this.shifts.set(item.date, s);
            }
          });
        }
        this.render();
      }

      renderStructure() {
        this.container.innerHTML = `
          <div class="card calendar-card" style="background:transparent; border:none; padding:0;">
            <div class="cal-header">
              <div class="cal-title" id="calTitle"></div>
              <div class="cal-nav">
                <button class="cal-btn" id="calPrev">‚Üê</button>
                <button class="cal-btn" id="calToday">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="cal-btn" id="calNext">‚Üí</button>
              </div>
            </div>
            <div class="cal-grid" id="calDow"></div>
            <div class="cal-grid" id="calGrid"></div>
          </div>
        `;
        const dowRow = document.getElementById('calDow');
        ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d => {
          const el = document.createElement('div');
          el.className = 'cal-dow';
          el.textContent = d;
          dowRow.appendChild(el);
        });
      }

      attachEvents() {
        document.getElementById('calPrev').onclick = () => { this.cursor.setMonth(this.cursor.getMonth() - 1); this.loadMyShifts(); };
        document.getElementById('calNext').onclick = () => { this.cursor.setMonth(this.cursor.getMonth() + 1); this.loadMyShifts(); };
        document.getElementById('calToday').onclick = () => { this.cursor = new Date(); this.loadMyShifts(); };
      }

      render() {
        const grid = document.getElementById('calGrid');
        const title = document.getElementById('calTitle');
        grid.innerHTML = '';
        const y = this.cursor.getFullYear();
        const m = this.cursor.getMonth();
        title.textContent = new Date(y, m, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(y, m, 1);
        let startOffset = firstDay.getDay() || 7;
        startOffset -= 1;

        for(let i=0; i<startOffset; i++) {
          const el = document.createElement('div'); el.className = 'cal-day other'; grid.appendChild(el);
        }

        const daysInMonth = new Date(y, m+1, 0).getDate();
        const todayStr = new Date().toISOString().slice(0, 10);

        for(let d=1; d<=daysInMonth; d++) {
          const dateObj = new Date(y, m, d);
          const dateKey = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
          
          const cell = document.createElement('div');
          cell.className = 'cal-day';
          if (dateKey === todayStr) cell.classList.add('today');

          const num = document.createElement('div'); num.className = 'daynum'; num.textContent = d;
          cell.appendChild(num);

          if (this.shifts.has(dateKey)) {
            const shift = this.shifts.get(dateKey);
            const marker = document.createElement('div');
            marker.className = 'shift-marker';
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç —Å–º–µ–Ω—ã (10:00-19:00)
            marker.textContent = `${shift.start_time.slice(0,5)}‚Äì${shift.end_time.slice(0,5)}`;
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ "—Ä–∞–±–æ—á–µ–≥–æ" —Å—Ç–∏–ª—è
            cell.appendChild(marker);
          }
          grid.appendChild(cell);
        }
      }
    }

    class ScheduleManager {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.currentDate = new Date();
        this.employees = [];
        this.shiftTypes = [];
        this.scheduleData = [];
      }

      async init() {
        this.container.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // Use global cached data
        this.employees = sortEmployeesForSchedule(await getAllEmployees());
        this.shiftTypes = await getShiftTypes();
        
        this.renderControls();
        await this.loadMonthData();
      }

      renderControls() {
        const y = this.currentDate.getFullYear();
        const m = this.currentDate.getMonth();
        const monthName = new Date(y, m, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });

        this.container.innerHTML = `
          <div class="schedule-controls">
            <div class="month-nav">
              <button id="schedPrev" class="btn btn-sm">‚Üê</button>
              <h2 style="text-transform: capitalize; margin: 0 15px;">${monthName}</h2>
              <button id="schedNext" class="btn btn-sm">‚Üí</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="schedule-table" id="schedTable">
              <thead id="schedHead"></thead>
              <tbody id="schedBody"></tbody>
              <tfoot id="schedFoot"></tfoot>
            </table>
          </div>
          <div id="schedLegend" class="legend-grid"></div>
        `;
        document.getElementById('schedPrev').onclick = () => this.changeMonth(-1);
        document.getElementById('schedNext').onclick = () => this.changeMonth(1);
        this.renderLegend();

        // Only —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–º–µ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è; –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö
      }
      
      renderLegend() {
        const leg = document.getElementById('schedLegend');
        leg.innerHTML = '';
        
        // Define Groups
        const groups = [
            { title: '–î–∏—Ä–µ–∫—Ç–æ—Ä (1.0)', ids: [1, 2], color: '#ffeb3b', textColor: '#000' },
            { title: '–ü—Ä–æ–¥–∞–≤—Ü—ã (0.75)', ids: [3, 4, 5, 6, 7], color: '#4caf50', textColor: '#fff' },
            { title: '–ü—Ä–æ–¥–∞–≤—Ü—ã (0.5)', ids: [8, 9, 10, 11, 12], color: '#2196f3', textColor: '#fff' }
        ];

        groups.forEach(group => {
            // Group Header
            const header = document.createElement('div');
            header.style.gridColumn = '1 / -1';
            header.style.marginTop = '15px';
            header.style.marginBottom = '5px';
            header.style.fontSize = '12px';
            header.style.fontWeight = 'bold';
            header.style.color = 'var(--text-muted)';
            header.style.borderBottom = '1px solid var(--border-color)';
            header.textContent = group.title;
            leg.appendChild(header);

            // Filter shifts for this group
            const groupShifts = this.shiftTypes.filter(s => group.ids.includes(s.id));
            
            groupShifts.forEach(s => {
               const div = document.createElement('div');
               div.className = 'legend-item';
               div.innerHTML = `<div class="legend-key" style="border-color:${group.color}; color:${group.color}">${s.id}</div> 
                                <span>${s.start_time.slice(0,5)}‚Äì${s.end_time.slice(0,5)}</span>`;
               leg.appendChild(div);
            });
        });

        // Output any other shifts not in groups (e.g. Cleaners or custom)
        const knownIds = groups.flatMap(g => g.ids);
        const others = this.shiftTypes.filter(s => !knownIds.includes(s.id));
        
        if (others.length > 0) {
            const header = document.createElement('div');
            header.style.gridColumn = '1 / -1';
            header.style.marginTop = '15px';
            header.style.borderBottom = '1px solid var(--border-color)';
            header.textContent = '–ü—Ä–æ—á–∏–µ';
            leg.appendChild(header);
            
            others.forEach(s => {
               const div = document.createElement('div');
               div.className = 'legend-item';
               div.innerHTML = `<div class="legend-key">${s.id}</div> <span>${s.start_time.slice(0,5)}‚Äì${s.end_time.slice(0,5)}</span>`;
               leg.appendChild(div);
            });
        }

        // –î–æ–±–∞–≤–∏–º B - –≤—ã—Ö–æ–¥–Ω–æ–π
        const headerB = document.createElement('div');
        headerB.style.gridColumn = '1 / -1';
        headerB.style.marginTop = '15px';
        headerB.style.borderBottom = '1px solid var(--border-color)';
        headerB.textContent = '–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è';
        leg.appendChild(headerB);

        const divB = document.createElement('div');
        divB.className = 'legend-item';
        divB.innerHTML = `<div class="legend-key key-b">B</div> <span>–í—ã—Ö–æ–¥–Ω–æ–π</span>`;
        leg.appendChild(divB);
      }

      changeMonth(delta) {
        this.currentDate.setMonth(this.currentDate.getMonth() + delta);
        this.renderControls();
        this.loadMonthData();
      }

      async loadMonthData() {
        const y = this.currentDate.getFullYear();
        const m = this.currentDate.getMonth() + 1;
        const monthStr = `${y}-${String(m).padStart(2, '0')}`;
        if (!supabase) { this.scheduleData = []; this.renderTable(y, m - 1); return; }
        const { data } = await supabase.from('schedule').select('*').eq('month', monthStr);
        this.scheduleData = data || [];
        this.renderTable(y, m - 1);
      }

      renderTable(year, month) {
        const thead = document.getElementById('schedHead');
        const tbody = document.getElementById('schedBody');
        const tfoot = document.getElementById('schedFoot');
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
        
        // --- HEADER ---
        // Always render header to ensure dates are correct for the month
        let headerHtml = '<tr><th rowspan="2">‚Ññ</th><th rowspan="2" class="sticky-col">–§–∞–º–∏–ª–∏—è –ò. –û.</th><th rowspan="2">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>';
        for (let d = 1; d <= daysInMonth; d++) {
           const dateObj = new Date(year, month, d);
           const dayName = dateObj.toLocaleDateString('ru-RU', { weekday: 'short' });
           const isWeekend = (dayName === '—Å–±' || dayName === '–≤—Å') ? 'weekend' : '';
           headerHtml += `<th class="${isWeekend}">${d}</th>`;
        }
        headerHtml += '<th rowspan="2">–ò—Ç–æ–≥–æ<br>—á–∞—Å–æ–≤</th><th rowspan="2">–í—ã—Ö</th></tr><tr>';
        for (let d = 1; d <= daysInMonth; d++) {
           const dateObj = new Date(year, month, d);
           const dayName = dateObj.toLocaleDateString('ru-RU', { weekday: 'short' });
           const isWeekend = (dayName === '—Å–±' || dayName === '–≤—Å') ? 'weekend' : '';
           headerHtml += `<th class="${isWeekend}" style="font-size:10px">${dayName}</th>`;
        }
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;

        // --- BODY ---
        // Check if we can perform a smart update
        // We need full rebuild if:
        // 1. Employee list changed length
        // 2. Month changed (different days count)
        // 3. Table is empty
        const shouldRebuild = tbody.children.length !== this.employees.length || 
                              tbody.dataset.month !== monthStr;
        
        tbody.dataset.month = monthStr; // Update marker

        if (this.employees.length === 0) { tbody.innerHTML = '<tr><td colspan="40">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.</td></tr>'; return; }
        
        if (shouldRebuild) {
             tbody.innerHTML = ''; // Clear for full rebuild
        }

        // Arrays for totals per day
        const dayCounts = new Array(daysInMonth + 1).fill(0);

        this.employees.forEach((user, idx) => {
          let tr;
          if (shouldRebuild) {
              tr = document.createElement('tr');
              tbody.appendChild(tr);
          } else {
              tr = tbody.children[idx];
          }

          // --- Row Content Building ---
          // If rebuilding, create full structure. If updating, only touch cells.
          // Note: To keep code simple and robust, we will regenerate the innerHTML of the row 
          // ONLY if it's a rebuild. If it's an update, we'll iterate cells.
          // Actually, regenerating row innerHTML kills selection too.
          // So, for smooth update, we must access existing cells.
          
          let totalHours = 0;
          let totalDaysOff = 0;
          
          // Meta info (cols 0, 1, 2)
          if (shouldRebuild) {
              let roleName = user.role === 'director' ? '–î–∏—Ä–µ–∫—Ç–æ—Ä' : (user.role === 'senior_seller' ? '–°—Ç. –ø—Ä–æ–¥–∞–≤–µ—Ü' : '–ü—Ä–æ–¥–∞–≤–µ—Ü');
              // Create 3 meta cells + N day cells + 2 total cells
              // Total cells = 3 + daysInMonth + 2
              let html = `<td>${idx + 1}</td>
                          <td class="sticky-col" style="text-align:left; padding-left:10px;">${user.full_name}</td>
                          <td>${roleName}</td>`;
              
              for (let d = 1; d <= daysInMonth; d++) html += `<td class="day-cell" data-d="${d}"></td>`;
              html += `<td class="total-hours"></td><td class="total-days"></td>`;
              tr.innerHTML = html;
          }

          // Update Day Cells
          for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const record = this.scheduleData.find(s => s.user_id === user.id && s.date === dateStr);
            const shiftId = record ? record.shift_id : null;
            
            if (shiftId) dayCounts[d]++;
            else totalDaysOff++;

            // Calculate Hours
            if (shiftId) {
                const shiftInfo = this.shiftTypes.find(s => s.id === shiftId);
                if (shiftInfo) {
                   if (shiftInfo.work_hours !== undefined && shiftInfo.work_hours !== null) {
                       totalHours += parseFloat(shiftInfo.work_hours);
                   } else {
                       const startH = parseInt(shiftInfo.start_time.split(':')[0]);
                       const endH = parseInt(shiftInfo.end_time.split(':')[0]);
                       let duration = endH - startH;
                       if (duration < 0) duration += 24; 
                       totalHours += (duration - 1); 
                   }
                }
            }

            // Cell Management
            // Index offset: 3 (meta) + d - 1
            const cellIndex = 3 + (d - 1);
            const td = tr.children[cellIndex];
            
            // If cell doesn't exist (edge case), skip
            if (!td) continue;

            // Check permissions
            const canEdit = ['director', 'senior_seller'].includes(currentUser.role);

            if (canEdit) {
                // Check if select exists
                let select = td.querySelector('select');
                if (!select) {
                    select = document.createElement('select');
                    select.dataset.userId = user.id;
                    select.dataset.date = dateStr;
                    select.onchange = (e) => this.handleShiftChange(e.target);
                    td.innerHTML = '';
                    td.appendChild(select);
                    
                    // Populate Options (only once)
                    const optB = document.createElement('option'); optB.value = ''; optB.text = 'B'; 
                    select.appendChild(optB);

                    let allowedShifts = this.shiftTypes;
                    if (user.role === 'director') allowedShifts = this.shiftTypes.filter(st => [1, 2].includes(st.id));
                    else allowedShifts = this.shiftTypes.filter(st => ![1, 2].includes(st.id));

                    // Add legacy/missing
                    // We can't easily check shiftId here for *creation* because it might change later.
                    // But we should ensure all shifts are present.
                    // For performance, we add all relevant shifts.
                    // If a shiftId appears that is NOT in allowed, we might need to re-add it dynamically, 
                    // but that's rare. Let's stick to standard groups.

                    const groups = [
                        { label: '–î–∏—Ä–µ–∫—Ç–æ—Ä (1.0)', ids: [1, 2] },
                        { label: '–ü—Ä–æ–¥–∞–≤—Ü—ã (0.75)', ids: [3, 4, 5, 6, 7] },
                        { label: '–ü—Ä–æ–¥–∞–≤—Ü—ã (0.5)', ids: [8, 9, 10, 11, 12] }
                    ];

                    groups.forEach(g => {
                        const groupShifts = allowedShifts.filter(s => g.ids.includes(s.id));
                        if (groupShifts.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = g.label;
                            groupShifts.sort((a,b) => a.id - b.id).forEach(st => {
                                const opt = document.createElement('option');
                                opt.value = st.id;
                                opt.textContent = `${st.id}`;
                                optgroup.appendChild(opt);
                            });
                            select.appendChild(optgroup);
                        }
                    });
                    
                    // Others
                    const knownIds = groups.flatMap(g => g.ids);
                    const others = allowedShifts.filter(s => !knownIds.includes(s.id));
                    if (others.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = '–ü—Ä–æ—á–∏–µ';
                        others.sort((a,b) => a.id - b.id).forEach(st => {
                             const opt = document.createElement('option');
                             opt.value = st.id;
                             opt.textContent = `${st.id}`;
                             optgroup.appendChild(opt);
                        });
                        select.appendChild(optgroup);
                    }
                }
                
                // Update Value only if changed (prevents flicker/focus loss)
                // Note: shiftId is number or null. select.value is string.
                const newVal = shiftId ? String(shiftId) : '';
                if (select.value !== newVal) {
                    select.value = newVal;
                    // Also update legacy/missing option if needed? 
                    // (Skipping complexity for now, assuming standard shifts)
                }

                // Update Style
                select.className = `cell-input ${shiftId ? 'cell-work' : 'cell-b'}`;
                
                // Tooltip
                if (shiftId) {
                   const s = this.shiftTypes.find(x => x.id === shiftId);
                   if (s) select.title = `–°–º–µ–Ω–∞ ${s.id}: ${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)}`;
                } else {
                    select.title = '';
                }

            } else {
                // Read-only
                let div = td.querySelector('div.cell-input');
                if (!div) {
                    div = document.createElement('div');
                    td.innerHTML = '';
                    td.appendChild(div);
                }
                
                div.className = `cell-input ${shiftId ? 'cell-work' : 'cell-b'}`;
                div.style.cursor = 'default';
                
                if (shiftId) {
                   const s = this.shiftTypes.find(x => x.id === shiftId);
                   div.textContent = s ? `${s.id}` : shiftId;
                   if (s) div.title = `${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)}`;
                   div.style.fontSize = '11px';
                } else {
                   div.textContent = 'B';
                   div.title = '';
                }
            }
          } // end for days

          // Update Totals
          const cellTotalH = tr.children[3 + daysInMonth];
          const cellTotalD = tr.children[3 + daysInMonth + 1];
          if (cellTotalH) cellTotalH.innerHTML = `<b>${totalHours}</b>`;
          if (cellTotalD) cellTotalD.innerHTML = `${totalDaysOff}`;
        });

        // --- FOOTER (Totals) ---
        let footHtml = '<tr><td colspan="3" style="text-align:right; font-weight:bold; padding-right:10px;">–ò—Ç–æ–≥–æ —Å–º–µ–Ω:</td>';
        for (let d = 1; d <= daysInMonth; d++) {
            footHtml += `<td><b>${dayCounts[d]}</b></td>`;
        }
        footHtml += '<td>-</td><td>-</td></tr>';
        tfoot.innerHTML = footHtml;
      }

      async handleShiftChange(select) {
        const userId = select.dataset.userId;
        const date = select.dataset.date;
        const val = select.value; 
        const shiftId = val ? parseInt(val) : null;
        const monthStr = date.slice(0, 7);
        
        // Optimistic UI update
        if (select.tagName === 'SELECT') {
             select.className = `cell-input ${shiftId ? 'cell-work' : 'cell-b'} saving`;
        }
        try {
          if (!supabase) throw new Error('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
          const uid = String(userId);
          const check = await supabase
            .from('schedule')
            .select('user_id, date')
            .eq('user_id', uid)
            .eq('date', date)
            .maybeSingle();
          if (check.error && check.error.message && !check.error.message.toLowerCase().includes('no rows')) {
            throw check.error;
          }
          if (check.data) {
            const upd = await supabase
              .from('schedule')
              .update({ shift_id: shiftId, is_day_off: !shiftId })
              .eq('user_id', uid)
              .eq('date', date);
            if (upd.error) throw upd.error;
          } else {
            const ins = await supabase
              .from('schedule')
              .insert({ user_id: uid, date, month: monthStr, shift_id: shiftId, is_day_off: !shiftId });
            if (ins.error) throw ins.error;
          }
          showToast('–°–º–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } catch (error) {
            console.error('Save shift error:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–º–µ–Ω—ã: ' + (error.message || '')); 
            if (select.classList) select.classList.add('error');
            return;
        } finally {
          if (select.classList) select.classList.remove('saving');
          // Update cache
          const idx = this.scheduleData.findIndex(s => s.user_id === userId && s.date === date);
          if (idx >= 0) {
             if (shiftId === null) {
                 this.scheduleData[idx].shift_id = null;
             } else {
                 this.scheduleData[idx].shift_id = shiftId;
             }
          } else {
            this.scheduleData.push({ user_id: userId, date, month: monthStr, shift_id: shiftId });
          }
          // Soft refresh totals
          await this.loadMonthData();
        }
      }
    }

    // --- MAIN INITIALIZATION ---
    let autoRefreshInterval = null;
    let heartbeatInterval = null;

    // Initialize immediately when DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM Ready');
      
      // 1. Try to restore session
      try {
          currentUser = getCurrentUser();
      } catch (e) {
          console.error('Session restore error:', e);
          currentUser = null;
      }

      // 2. Route to view
      if (currentUser) {
        // Verify and refresh full user row to avoid stale localStorage (photo_url etc.)
        const dbUser = await verifyUser(currentUser.login, currentUser.password);
        if (dbUser) {
            currentUser = dbUser;
            try { localStorage.setItem('ax_user', JSON.stringify(currentUser)); } catch {}
            showAppView();
        } else {
            logoutUser();
        }
      } else {
        showLoginView();
      }
    });

    // Verify user credentials against DB silently
    async function verifyUser(login, password) {
        if (!supabase) return currentUser; // Offline fallback: keep local user
        try {
            const { data, error } = await supabase
                .from('employees')
                .select('*')
                .eq('login', login)
                .eq('password', password)
                .maybeSingle();
            if (error) return null;
            return data || null;
        } catch (e) {
            console.warn('Verify user failed:', e);
            return currentUser; // Keep local to avoid lockout
        }
    }

    function showLoginView() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      
      const loginView = document.getElementById('login-view');
      const appView = document.getElementById('app-view');
      if (loginView) loginView.style.display = 'flex';
      if (appView) appView.style.display = 'none';
      
      initLoginEvents();
    }

    async function showAppView() {
      const loginView = document.getElementById('login-view');
      const appView = document.getElementById('app-view');
      if (loginView) loginView.style.display = 'none';
      if (appView) appView.style.display = 'block';
      
      await initApp();
      startAutoRefresh();
      startHeartbeat();
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(async () => {
            if (document.hidden) return; 
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.dataset.tab === 'schedule') {
                if (document.getElementById('myScheduleView').style.display !== 'none' && window.calendarApp) {
                     await window.calendarApp.loadMyShifts();
                }
                if (document.getElementById('teamScheduleView').style.display !== 'none' && window.scheduleApp) {
                     await window.scheduleApp.loadMonthData();
                }
            }
        }, 60000);
    }

    function startHeartbeat() {
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        heartbeatInterval = setInterval(async () => {
            if (!supabase) return;
            try {
              await Promise.all([
                supabase.from('shifts').select('id').limit(1),
                supabase.from('employees').select('id').limit(1),
                supabase.from('schedule').select('date').limit(1)
              ]);
            } catch (e) {}
        }, 120000);
    }

    function initLoginEvents() {
      console.log('Initializing Login Events...');
      const toggleBtn = document.getElementById('togglePassword');
      const passInput = document.getElementById('loginPassword');
      const loginBtn = document.getElementById('btnLogin');
      const loginEmail = document.getElementById('loginEmail');
      const errBox = document.getElementById('loginErrorMsg');

      if (!toggleBtn || !passInput || !loginBtn || !loginEmail || !errBox) {
        console.error('Login form elements not found. Aborting event binding.');
        return;
      }

      // --- Event Handlers ---
      const handleLogin = async (e) => {
        e.preventDefault();
        const login = loginEmail.value.trim();
        const password = passInput.value.trim();

        if (!login || !password) {
          errBox.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
          return;
        }

        loginBtn.disabled = true;
        const originalText = loginBtn.textContent;
        loginBtn.textContent = '–í—Ö–æ–¥...';
        errBox.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        errBox.style.color = '#888';

        try {
          showLoader('–í—Ö–æ–¥...');
          await loginUser(login, password);
          currentUser = getCurrentUser();
          errBox.style.color = '#4caf50';
          errBox.textContent = '–£—Å–ø–µ—à–Ω–æ!';
          loginBtn.textContent = '–£—Å–ø–µ—à–Ω–æ!';
          await showAppView();
        } catch (err) {
          loginBtn.textContent = originalText;
          loginBtn.disabled = false;
          errBox.style.color = '#f44336';
          errBox.textContent = err.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
        } finally { hideLoader(); }
      };

      const handleTogglePassword = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passInput.setAttribute('type', type);
        toggleBtn.innerHTML = type === 'password'
          ? '<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>'
          : '<svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
        const svg = toggleBtn.querySelector('svg');
        if (svg) svg.style.fill = 'var(--text-muted)';
      };

      const onEnter = (e) => {
        if (e.key === 'Enter') {
          loginBtn.click();
        }
      };

      // --- Attach Events ---
      // Remove old listeners first to prevent duplicates
      loginBtn.onclick = null;
      toggleBtn.onclick = null;
      loginEmail.removeEventListener('keydown', onEnter);
      passInput.removeEventListener('keydown', onEnter);

      // Add new listeners
      loginBtn.onclick = handleLogin;
      toggleBtn.onclick = handleTogglePassword;
      loginEmail.addEventListener('keydown', onEnter);
      passInput.addEventListener('keydown', onEnter);
    }

    async function initApp() {
      try {
        try {
          await preloadGlobalData();
        } catch (e) {
          console.warn('Offline mode or error preloading data:', e);
        }

        // Run seed check
        if (typeof seedShifts === 'function') {
            seedShifts().catch(e => console.log('Seed warning:', e));
        }

      // Header Info
      if (currentUser) {
           document.getElementById('headerLogin').textContent = currentUser.full_name || currentUser.login;
           const roles = { 'director': '–î–∏—Ä–µ–∫—Ç–æ—Ä', 'senior_seller': '–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü', 'seller': '–ü—Ä–æ–¥–∞–≤–µ—Ü' };
           document.getElementById('headerRole').textContent = roles[currentUser.role] || currentUser.role;
           
           const fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.full_name || 'User')}&background=333&color=fff`;
           const avatarEl = document.getElementById('headerAvatar');
           const avatarUrl = currentUser.photo_url || fallback;
           if (avatarEl) {
             avatarEl.onerror = () => { avatarEl.src = fallback; };
             avatarEl.src = avatarUrl;
           }
        }

        // Theme
        if (localStorage.getItem('ax_theme') === 'light') {
          document.body.classList.add('light-theme');
        }
        
        // Modules
        window.calendarApp = new Calendar('calendar-wrapper');
        window.scheduleApp = new ScheduleManager('schedule-manager');
        await window.scheduleApp.init();
        
        // Tabs
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(t => {
            t.onclick = () => {
               tabs.forEach(x => x.classList.remove('active'));
               t.classList.add('active');
               document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
               document.getElementById(t.dataset.tab).classList.add('active');
               
               // Instant refresh on tab switch
               if (t.dataset.tab === 'schedule') {
                   if (window.scheduleApp) window.scheduleApp.loadMonthData();
                   if (window.calendarApp) window.calendarApp.loadMyShifts();
               }
            };
        });

        // Profile Menu Events
        const pBtn = document.getElementById('profileBtn');
        const pMenu = document.getElementById('profileMenu');
        
        const newPBtn = pBtn.cloneNode(true);
        pBtn.parentNode.replaceChild(newPBtn, pBtn);
        
        newPBtn.onclick = (e) => { e.stopPropagation(); pMenu.style.display = pMenu.style.display === 'block' ? 'none' : 'block'; };
        document.addEventListener('click', () => pMenu.style.display = 'none');
        
        // Logout
        document.getElementById('logoutBtn').onclick = logoutUser;
        
        // Theme Toggle
        document.getElementById('themeBtn').onclick = (e) => {
          e.stopPropagation();
          document.body.classList.toggle('light-theme');
          localStorage.setItem('ax_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        };

        // Change Photo
        const avatarInput = document.getElementById('avatarUploadInput');
        if (avatarInput) {
          const changePhotoBtn = document.getElementById('changePhotoBtn');
          if (changePhotoBtn) {
             changePhotoBtn.onclick = (e) => {
               e.stopPropagation();
               avatarInput.click();
               pMenu.style.display = 'none';
             };
          }

          avatarInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
              if (changePhotoBtn) changePhotoBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
              const url = await uploadFile('photos', file);
              const { error } = await supabase.from('employees').update({ photo_url: url }).eq('id', currentUser.id);
              if (error) throw error;
              currentUser.photo_url = url;
              localStorage.setItem('ax_user', JSON.stringify(currentUser));
              document.getElementById('headerAvatar').src = url;
              alert('–§–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
            } catch (err) {
              alert('–û—à–∏–±–∫–∞: ' + err.message);
            } finally {
              e.target.value = '';
              if (changePhotoBtn) changePhotoBtn.innerHTML = '<span>üì∏</span> –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
            }
          };
        }

        // Change Password
        document.getElementById('changePassBtn').onclick = (e) => {
          e.stopPropagation();
          document.getElementById('modalChangePass').style.display = 'flex';
          pMenu.style.display = 'none';
        };

        document.getElementById('btnSavePass').onclick = async () => {
          const oldP = document.getElementById('oldPass').value;
          const newP = document.getElementById('newPass').value;
          if (!oldP || !newP) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
          if (oldP !== currentUser.password) return alert('–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π');
          const { error } = await supabase.from('employees').update({ password: newP }).eq('id', currentUser.id);
          if (error) alert('–û—à–∏–±–∫–∞: ' + error.message);
          else {
            alert('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω! –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
            logoutUser();
          }
        };



        // Role Based Access
        const isAdmin = ['director', 'senior_seller'].includes(currentUser.role);
        
        if (isAdmin) {
          document.getElementById('adminTab').style.display = 'block';
          loadUsersTable();
        }

        loadContent();
        
        const btnMy = document.getElementById('viewMySched');
        const btnTeam = document.getElementById('viewTeamSched');
        btnMy.onclick = () => {
          document.getElementById('myScheduleView').style.display = 'block';
          document.getElementById('teamScheduleView').style.display = 'none';
          btnMy.classList.add('active'); btnTeam.classList.remove('active');
        };
        btnTeam.onclick = () => {
          document.getElementById('myScheduleView').style.display = 'none';
          document.getElementById('teamScheduleView').style.display = 'block';
          btnTeam.classList.add('active'); btnMy.classList.remove('active');
        };

        const btnUpload = document.getElementById('btnUploadMerch');
        if(btnUpload) {
          const uploadInput = document.getElementById('uploadMerchInput');
          if (uploadInput) {
             btnUpload.onclick = () => uploadInput.click();
             uploadInput.onchange = handleMerchUpload;
          }
        }
        
        const btnCreate = document.getElementById('btnCreateUser');
        if(btnCreate) btnCreate.onclick = createUserHandler;

      // 1S Search
      try {
        const tab1S = document.getElementById('tab-1s');
        if (tab1S) {
            const searchInput = tab1S.querySelector('.search-input');
            const list = tab1S.querySelector('.list-group');
            if (searchInput && list) {
                const load1S = async (q='') => {
                   list.innerHTML = '<div class="loader">–ü–æ–∏—Å–∫...</div>';
                   let query = supabase.from('manuals').select('*').order('title');
                   if(q) query = query.ilike('title', `%${q}%`);
                   const { data } = await query;
                   list.innerHTML = '';
                   if(!data || !data.length) { list.innerHTML = '<div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
                   data.forEach(item => {
                     const el = document.createElement('div'); el.style.padding='10px'; el.style.borderBottom='1px solid #333'; el.style.cursor='pointer';
                      el.textContent = item.title;
                      el.onclick = () => openModal('modalInfo', item.title, item.content || '–ü—É—Å—Ç–æ');
                      list.appendChild(el);
                   });
                };
                load1S();
                searchInput.addEventListener('input', (e) => load1S(e.target.value));
            }
        }
      } catch (err) {
         console.warn('1S module init error', err);
      }

      } catch (err) {
        console.error('INIT ERROR:', err);
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + err.message);
      }
    }

  async function loadContent() {
      const merchGrid = document.getElementById('merchGrid');
      if (merchGrid) {
        const items = await getMerchItems();
        merchGrid.innerHTML = items.length ? '' : '<p style="text-align:center;width:100%">–ù–µ—Ç —Ñ–æ—Ç–æ</p>';
        items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'photo-card';
          const url = item.image_url;
          const isVideo = url && (url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.ogg'));
          if (isVideo) {
            el.innerHTML = `<video src="${url}" controls style="width:100%;height:100%;object-fit:cover"></video><div class="photo-title">${item.title}${item.description ? ' ‚Äî ' + item.description : ''}</div>`;
          } else {
            el.style.backgroundImage = `url('${url}')`;
            el.innerHTML = `<div class="photo-title">${item.title}${item.description ? ' ‚Äî ' + item.description : ''}</div>`;
          }
          merchGrid.appendChild(el);
        });
      }
    }

  async function handleMerchUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const btn = document.getElementById('btnUploadMerch');
      const oldText = btn.textContent;
      btn.textContent = '...'; btn.disabled = true;
      try {
        showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞...');
        const url = await uploadFile('photos', file);
        const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ:', file.type.startsWith('video') ? '–í–∏–¥–µ–æ' : '–§–æ—Ç–æ');
        const desc = title ? prompt('–û–ø–∏—Å–∞–Ω–∏–µ:', '') : null;
        if (title) { await createMerchItem(desc ? `${title}` : title, url); loadContent(); }
      } catch (err) { alert(err.message); } 
      finally { btn.textContent = oldText; btn.disabled = false; e.target.value = ''; hideLoader(); }
    }

    async function loadUsersTable() {
      const tbody = document.querySelector('#usersTable tbody');
      if (!tbody) return;
      const users = sortEmployeesForSchedule(await getAllEmployees());
      tbody.innerHTML = '';
      const canDelete = currentUser.role === 'director';
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${u.full_name}</b><br><small style="color:#888">${u.login} | ${u.password}</small></td>
          <td>${u.role}</td>
          <td>
            <button class="btn btn-sm" onclick="openEditUser('${u.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            ${canDelete ? `<button class="btn btn-sm" onclick="deleteUserHandler('${u.id}')" style="color:red">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.deleteUserHandler = async (id) => {
      if (currentUser.role !== 'director') return alert('–¢–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä!');
      if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
      const { error } = await deleteEmployee(id);
      if (error) alert(error.message); else loadUsersTable();
    };

    async function createUserHandler() {
      const login = document.getElementById('newUserEmail').value;
      const password = document.getElementById('newUserPass').value;
      const fullName = document.getElementById('newUserName').value;
      const role = document.getElementById('newUserRole').value;
      if (!login || !password || !fullName) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      const { error } = await createEmployee({ login, password, full_name: fullName, role });
      if (error) alert(error.message); else { alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω!'); loadUsersTable(); }
  }
  // Modal helpers
  function openModal(id, title, html) {
    const m = document.getElementById(id);
    if (!m) return;
    const t = document.getElementById('modalTitle');
    const b = document.getElementById('modalBody');
    if (t) t.textContent = title || '';
    if (b) b.textContent = '';
    if (b) b.innerText = html || '';
    m.style.display = 'flex';
  }
  function closeModal(id) {
    const m = document.getElementById(id);
    if (m) m.style.display = 'none';
  }
  let currentEditUserId = null;
  function openEditUser(id) {
    const u = (globalEmployees || []).find(x => String(x.id) === String(id));
    if (!u) return;
    currentEditUserId = u.id;
    document.getElementById('editUserName').value = u.full_name || '';
    document.getElementById('editUserLogin').value = u.login || '';
    document.getElementById('editUserPass').value = u.password || '';
    document.getElementById('editUserRole').value = u.role || 'seller';
    openModal('modalEditUser', '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '');
  }
  (function bindEditUserEvents(){
    const btnPhoto = document.getElementById('btnEditPhoto');
    const input = document.getElementById('editPhotoInput');
    if (btnPhoto && input) {
      btnPhoto.onclick = () => input.click();
      input.onchange = async (e) => {
        const file = e.target.files[0]; if (!file || !currentEditUserId) return;
        try {
          showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...');
          const url = await uploadFile('photos', file);
          const res = await updateEmployee(currentEditUserId, { photo_url: url });
          if (res.error) alert(res.error.message); else showToast('–§–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
          await loadUsersTable();
        } catch(err) { alert(err.message); } finally { hideLoader(); e.target.value=''; }
      };
    }
    const btnSave = document.getElementById('btnSaveUser');
    if (btnSave) {
      btnSave.onclick = async () => {
        if (!currentEditUserId) return;
        const data = {
          full_name: document.getElementById('editUserName').value,
          login: document.getElementById('editUserLogin').value,
          password: document.getElementById('editUserPass').value,
          role: document.getElementById('editUserRole').value
        };
        try {
          showLoader('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
          const res = await updateEmployee(currentEditUserId, data);
          if (res.error) alert(res.error.message); else { showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); closeModal('modalEditUser'); }
          await loadUsersTable();
        } catch(err) { alert(err.message); } finally { hideLoader(); }
      };
    }
  })();

  function showToast(text) {
    const t = document.getElementById('toast');
    if (!t) return; t.textContent = text; t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none'; }, 2000);
  }
  </script>
</body>
</html>
